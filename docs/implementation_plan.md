# 实施计划 - CNC 控制终端 (Claude Code 风格)

# 目标描述
开发一个基于 .NET 9 的数控 (CNC) 软件控制终端。该工具将借鉴 "Claude Code" 的现代 CLI 交互体验，提供高效的指令执行、参数配置和状态监控功能。核心理念是将“与 AI 对话”的体验转化为“与机器对话”。

## 核心设计理念
- **对话式交互**: 像聊天一样发送指令（如 `move x 10` 或 `G0 X10`），机器以富文本形式反馈结果。
- **沉浸式状态**: 关键信息（坐标、状态）始终在底部可见，类似 IDE 的状态栏。
- **视觉层级**: 使用颜色和图标区分 正常信息 (Info)、警告 (Warning) 和 错误 (Error/Alarm)。

## 功能设计分析

### 1. 快速指令执行 (REPL)
- **混合输入模式**:
    - **G代码原生支持**: 直接输入 `G0 X100 Y50`，支持语法高亮。
    - **自然语言/快捷指令**: 输入 `home` 代替 `G28`，输入 `tool 1` 代替 `M6 T1`。
- **智能补全**:
    - 输入 `G` 时提示常用 G 代码列表。
    - 输入 `/` 时提示系统命令（如 `/config`, `/connect`）。
- **执行反馈**:
    - 长时间操作（如回零、运行文件）显示**进度条**或**Spinner**动画。
    - 危险操作（如清零坐标）弹出**确认对话框**。

### 2. 查看与修改参数
- **交互式表格**: 使用 `/params` 命令展示分类的参数表（轴参数、主轴参数、IO配置）。
- **搜索与过滤**: 支持 `/params axis` 仅显示轴相关参数。
- **快速修改**:
    - 命令式: `/set X_MAX 500`
    - 交互式: 选择参数后弹窗输入新值。

### 3. 查看状态
- **持久化页脚 (Status Bar)**:
    - **实时坐标 (DRO)**: 始终显示 X, Y, Z 当前位置 (高亮显示)。
    - **机器状态**: IDLE (空闲) / RUN (运行) / ALARM (报警)。
    - **进给/转速**: F (Feed), S (Speed)。
- **仪表盘视图**:
    - 命令 `/dashboard` 或 `/status` 清屏并显示全屏仪表盘（包含 IO 状态、电机负载图表等）。

### 4. 关键增强功能 (Critical Enhancements)
- **全局安全热键**:
    - `ESC`: 紧急停止 (E-Stop)。
    - `Space`: 进给保持 (Feed Hold)。
    - *实现*: 使用后台线程监听 `Console.ReadKey(true)`。
- **预演与仿真**:
    - **边界检查**: 解析 G 代码，计算包围盒，对比软限位。
    - **路径预览**: 使用 `Spectre.Console.Canvas` 绘制简单的 2D 刀路图。
- **刀具管理**:
    - `/tools`: 展示刀具表。
    - `/touchoff`: 自动对刀流程模拟。

## 建议变更

### 技术栈
- **框架**: .NET 9
- **UI 库**: `Spectre.Console`
- **模拟层**: `VirtualCncController` (包含坐标系统、刀具表、软限位逻辑)。

### 项目结构
- `KCode.CNC/`: 主项目
    - `Program.cs`: 程序入口。
    - `UI/`:
        - `LayoutRenderer.cs`: 管理整体布局（Header, Content, Footer）。
        - `StatusRenderer.cs`: 专门负责底部 DRO 和状态刷新。
        - `ParamTable.cs`: 参数表格渲染。
    - `Core/`:
        - `CommandParser.cs`: 解析 G代码和自然语言指令。
        - `CncState.cs`: 维护机器状态模型 (坐标, 报警, 模式)。
        - `VirtualMachine.cs`: 模拟 CNC 运动逻辑。

## 验证计划
### 交互测试
- **连接测试**: 启动时显示连接机器动画。
- **运动指令**: 输入 `G0 X10`，验证页脚坐标是否更新，主区域显示“移动完成”。
- **参数管理**: 输入 `/params`，验证表格渲染，尝试修改参数并确认生效。
- **报警模拟**: 模拟触发限位报警，验证界面是否变红并显示警告信息。
